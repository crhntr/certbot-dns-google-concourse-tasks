---
platform: linux

image_resource:
  type: docker-image
  source:
    repository: certbot/dns-google
    version: latest

outputs:
  - name: letsencrypt

inputs:
  - name: letsencrypt

params:

  DEBUG: # --debug

  CREDENTIALS:
  # REQUIRED

  PROPAGATION_SECONDS:
  # REQUIRED

  DOMAINS:
  # REQUIRED

run:
  path: sh
  args:
  - "-c"
  - |
    set -eux
    certbot --version

    if [ "$DEBUG" = true ] ; then
      DEBUG="--debug"
    else
      DEBUG=""
    fi

    cp --archive letsencrypt /etc/letsencrypt

    certbot certonly $DEBUG  \
      --dns-google \
      $DEBUG \
      --dns-google-credentials $CREDENTIALS \
      --dns-google-propagation-seconds $PROPAGATION_SECONDS \
      -d $DOMAINS

    cp --archive /etc/letsencrypt letsencrypt
